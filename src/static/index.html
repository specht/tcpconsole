<html>
<head>
<title>TCP Console</title>
<style type='text/css'>
body {
    margin-top: 64px;
    font-family: mono;
    font-size: 10pt;
}
#messages, #input, input, button { 
    font-family: mono;
    white-space: pre;
    font-size: 10pt;
    background-color: #f0f0f0;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px;
    margin: 8px 0;
}

button {
    cursor: pointer;
}

#input { 
    background-color: #c3def1;
    border: 1px solid #729fcf;
}
input {
    background-color: #fff;
}

.head {
    background-color: #eee;
    border-bottom: 1px solid #bbb;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    padding: 4px 16px;
    box-shadow: rgba(0,0,0,0.2) 0px 1px 10px;
}

.error {
    background-color: #fe9;
    color: #800;
    border-bottom: 1px solid #a94;
    position: fixed;
    top: 60px;
    left: 0;
    width: 100%;
    padding: 8px 16px;
    box-shadow: rgba(0,0,0,0.2) 0px 1px 10px;
    display: none;
}

/* The switch - the box around the slider */
.switch {
  position: relative;
  display: inline-block;
  width: 46px;
  height: 25px;
  top: -8px;
}

/* Hide default HTML checkbox */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* The slider */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .2s;
  transition: .2s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 21px;
  width: 21px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  -webkit-transition: .2s;
  transition: .2s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 2px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(21px);
  -ms-transform: translateX(21px);
  transform: translateX(21px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 100px;
}

.slider.round:before {
  border-radius: 50%;
}

span.rule {
    display: inline-block;
    border-left: 1px solid #ccc;
    border-right: 1px solid #fff;
    width: 0px;
    margin-left: 10px;
    margin-right: 10px;
    margin-top: -20px;
    margin-bottom: -24px;
    height: 60px;
    position: relative;
    top: 0px;
}

.green {
    color: #093;
}

</style>
</head>

<body>
    <div class='error'>
    </div>
    <div class='head'>
        TCP Console
        <span class='rule'></span>
        <input type='text' id='host' placeholder='Host' size='24' />
        <input type='text' id='port' placeholder='Port' size='5' />
        <span class='rule'></span>
        <label class="switch">
            <input type="checkbox" id='tls'>
            <span class="slider round"></span>
        </label>
        TLS
        <span class='rule'></span>
        <button id='connect'>Connect</button>
        <span class='rule'></span>
        <span id='status'>Disconnected</span>
    </div>
    <div>
        <input type="text" id="input" style='width: 100%;'/>
    </div>
<!--     <div id="messages"></div> -->

    <script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script type="text/javascript">
        var connected = false;
        function setup_ws(ws)
        {
            ws.onopen = function () {
                console.log('websocket opened!');
    //             append_li('ws.onopen');
    //             ws.send(JSON.stringify({action: 'open', host: 'nhcham.org', port: 443, tls: true}))
    //             ws.send(JSON.stringify({action: 'send', message: 'GET / HTTP/1.0'}))
    //             ws.send(JSON.stringify({action: 'send', message: 'Host: nhcham.org'}))
    //             ws.send(JSON.stringify({action: 'send', message: ''}))
            }
            ws.onmessage = function (msg) {
                data = JSON.parse(msg.data);
                console.log(data);
                if (data.connected === true)
                {
                    $('#connect').html('Disconnect');
                    $('#host').prop('disabled', true);
                    $('#port').prop('disabled', true);
                    $('#tls').prop('disabled', true);
                    $('#status').html('Connected');
                    $('#status').addClass('green');
                    connected = true;
                }
                else if (data.connected === false)
                {
                    $('#connect').html('Connect');
                    $('#host').prop('disabled', false);
                    $('#port').prop('disabled', false);
                    $('#tls').prop('disabled', false);
                    $('#status').html('Disconnected');
                    $('#status').removeClass('green');
                    connected = false;
                }
                else if (typeof(data.error) !== 'undefined')
                {
                    $('.error').html(data.error);
                    $('.error').slideDown(400).delay(2000).slideUp();
                }
    //             append_li(msg.data);
            }
            ws.onclose = function () {
                console.log('websocket closed, recreating connection!');
                ws = new WebSocket(ws_uri);
                setup_ws(ws);
                //             append_li('ws.onclose');
            }
        }
        
        var append_li = function (str) {
            $('#messages').text($('#messages').text() + str);
        }
        var ws_uri = 'ws://localhost:8020/ws';
        console.log(ws_uri);
        var ws = new WebSocket(ws_uri);
        setup_ws(ws);
        var input = $('#input')
        input.change(function () {
            var msg = input.val();
            $('<div>').text(msg).insertBefore(input);
//             ws.send(JSON.stringify({action: 'send', message: msg}))
            input.val("");
        });
        input.focus();
        $('#connect').click(function() {
            if (!connected)
                ws.send(JSON.stringify({
                    action: 'open', 
                    host: $('#host').val(), 
                    port: parseInt($('#port').val()), 
                    tls: $('#tls').prop('checked')
                }))
            else
                ws.send(JSON.stringify({
                    action: 'close'
                }));
        });
    </script>
</body>
</html>
